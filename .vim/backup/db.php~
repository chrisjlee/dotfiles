<?php

global $user;

class DB {


	private $connect;

	protected $query;
	protected $result;
	protected $num_rows;
	protected $row;

	public function __construct() {

		$this->connect = mysql_connect(DB_HOST, DB_USER, DB_PASS);
		$select = mysql_select_db(DATABASE);

	}

	public function query($query) {

	        if ($this->query = mysql_query($query)) {
			$this->row = 0;
			$this->num_rows = mysql_num_rows($this->query);
			return true;
		}
		else return false;

	}

	public function rewind() {

		$this->row = 0;
	 	mysql_data_seek($this->result, 0);

	}

	public function write() {
        	if ($this->num_rows < 0) $this->insert();
		elseif ($this->num_rows == 1) $this->update();
	}

	protected function insert() {
         	//overwrite this, please

	}

	protected function update() {
         	//overwrite this, please
	}

}

class Checkin extends DB {

        private $id;
	private $member;
	private $day;
	private $time;

	function __construct($checkin = array()) {

         	parent::__construct();

		$sql = "SELECT * FROM `checkins`";

		if (isset($checkin['day'])) {

			if ($checkin['day'] == 'today') $sql .= " WHERE `time` >= CURRENT_DATE AND `time` < CURRENT_DATE + INTERVAL 1 DAY LIMIT 1";
			else {

				$day = $checkin['day'];
				$sql .= " WHERE `time` >= $day AND `time` < $day + INTERVAL 1 DAY LIMIT 1";

			}

		}
		else if (isset($checkin['user'])) {

			$user = $checkin['user'];
	        	$sql .= " WHERE `member_id` = $user";

		}

		$sql .= " ORDER BY `time` ASC";

	        $this->query($sql);

	}

	public function the_checkin() {

		if ($this->result = @mysql_fetch_array($this->query)) {
                        $data = $this->result;
	                $this->row++;
		        $this->id = $data['id'];
			$this->member = $data['member_id'];
			$this->day = $data['day_id'];
			$this->time = $data['time'];
			return $data;
		}
		else {
			return null;
		}

	}

	public function get_time() {
		return $this->time;
	}

	public function the_day() {
               return date('M j', strtotime($this->time));
	}

}

class User extends DB {

	private $id;
	private $username;
	private $email;
	private $password;
	private $voice;
	private $thumb;
	private $permissions = array();

	function __construct($user = null) {

		parent::__construct();

		if (!is_null($user)) {
			if (is_array($user)) {
                                if (isset($user['id'])) $this->id = $user['id'];
                                if (isset($user['username'])) $this->username = $user['username'];
                                if (isset($user['email'])) $this->email = $user['email'];
                                if (isset($user['password'])) $this->password = $user['password'];
                                if (isset($user['voice'])) $this->voice = $user['voice'];
				if (isset($user['thumb'])) $this->thumb = $user['thumb'];
                                if (isset($user['permissions'])) $this->permissions = $user['permissions'];
			}
			if (is_int($user)) {
                         	$this->query("SELECT * FROM `members` WHERE `id` = '$user' LIMIT 1");
				$this->the_user();
			}
			if (is_string($user)) {
				$this->query("SELECT * FROM `members` WHERE `email` = '$user' LIMIT 1");
				$this->the_user();
			}
		}

	}

	public function query_members($user = null) {

		$this->query('SELECT * FROM members');

	}

	public function change_user ($user) {
			if (is_array($user)) {
                                if (isset($user['id'])) $this->id = $user['id'];
                                if (isset($user['username'])) $this->username = $user['username'];
                                if (isset($user['email'])) $this->email = $user['email'];
                                if (isset($user['password'])) $this->password = $user['password'];
                                if (isset($user['voice'])) $this->voice = $user['voice'];
				if (isset($user['thumb'])) $this->thumb = $user['thumb'];
                                if (isset($user['permissions'])) $this->permissions = $user['permissions'];
			}
	}

	public function the_user() {

                if ($this->result = @mysql_fetch_array($this->query)) {
			$data = $this->result;
			$this->row++;
			$this->id = $data['id'];
			$this->username = $data['name'];
			$this->email = $data['email'];
			$this->password = $data['password'];
			$this->voice = $data['voice'];
			$this->thumb = $data['thumb'];

		     // need to decode permissions before storing it
			$this->permissions = json_decode(stripslashes($data['permissions']));
			if (is_null($this->permissions)) $this->permissions = array();
			return true;

		}
		else {
			return null;
		}

	}

	function find_user($method) {
		if ($method == 'email') $sql = "SELECT * FROM `members` WHERE `email` = '$this->email'";
		if ($method == 'id') $sql = "SELECT * FROM `members` WHERE `id` = '$this->id'";
                
		$this->query($sql);

		if ($this->num_rows > 0) return true;
		else return false;

	}

	function validate($password) {
         	if (md5($password) == $this->password) return true;
		else return false;
	}

	function is_checkedin() {
         	$sql = "SELECT * FROM `checkins` WHERE `member_id` = $this->id AND `time` >= CURRENT_DATE AND `time` < CURRENT_DATE + INTERVAL 1 DAY LIMIT 1";
		if ($query = mysql_query($sql)) {
               	       if (mysql_num_rows($query)) return true;
		       else return false;
		}
		else return false;
	}

	function checkin() {
		if ($this->is_checkedin()) {
                        $query = "DELETE FROM `checkins` WHERE `member_id` = $this->id AND `time` >= CURRENT_DATE and `time` < CURRENT_DATE + INTERVAL 1 DAY LIMIT 1";
			if (mysql_query($query)) return true;
			else return false;
		}
		else {
			$query = "INSERT INTO `checkins` (`id`, `member_id`, `day_id`, `time`) VALUES (NULL, '$this->id', NULL, CURRENT_TIMESTAMP)";
			if (mysql_query($query)) return true;
			else return false;
		}
	}

	function total_checkins() {
               $checkin = new Checkin(array('user' => $this->id));
	       return $checkin->num_rows;
	}

	function get_id() {
         	return $this->id;
	}

	function is_admin($permission) {
		if (in_array($permission, $this->permissions)) return true;
		else return false;
	}

	function add_permission($permission) {
         	if (!$this->is_admin($permission)) $this->permissions[] = $permission;
	}

	function get_name() {
         	return $this->username;
	}

	function get_email() {
         	return $this->email;
	}

	function get_voice() {
         	return $this->voice;
	}
	
	function get_permissions() {
		return $this->permissions;
	}

	function get_thumb() {
		if ($this->thumb == "") return 'template/images/default-avatar.jpg';
		else return $this->thumb;
	}

	function insert() {
		if (is_null($this->password)) return false;
		$query = "INSERT INTO `members` (`id`, `name`, `email`, `password`, `voice`, `thumb`, `permissions`) VALUES (NULL, '$this->username', '$this->email', '$this->password', '$this->voice', '$this->thumb', '$this->permissions')";
		if (mysql_query($query)) return true;
		else return false;
	}

	function update() {
		$name = $this->username;
		$permissions = mysql_real_escape_string(json_encode($this->permissions));

		$query = "UPDATE `members` SET ".
		"`name` = '$this->username', ".
		"`email` = '$this->email', ".
		"`password` = '$this->password', ".
		"`voice` = '$this->voice', ".
		"`thumb` = '$this->thumb', ".
		"`permissions` = '$permissions' ".
		"WHERE `members`.`id` =$this->id";

		if (mysql_query($query)) return true;
		else return false;
	}

	function destruct() {
		$sql = "DELETE FROM `members` WHERE `id` = $this->id";
         	if (mysql_query($sql)) return true;
		else false;
	}

}

function the_id() {
	global $user;
   	echo $user->get_id();
}

function the_name() {
	global $user;
   	echo $user->get_name();
}

function the_voice() {
	global $user;
   	echo $user->get_voice();
}

function the_total_checkins() {
 	global $user;
	echo $user->total_checkins();
}

function is_checkedin() {
 	global $user;
	if ($user->is_checkedin()) return true;
	else return false;
}

function the_thumb() {
	global $user;
   	echo $user->get_thumb();
}

?>
